# AGENTS.md

Instructions for AI coding agents working on the OpenPersona codebase.

## Project Overview

OpenPersona is an open four-layer agent framework (Soul / Body / Faculty / Skill) for creating, composing, and orchestrating agent persona skill packs. It generates self-contained skill packs that give AI agents a complete identity.

**Key distinction:** This repo is the *framework itself*, not a persona. The `skills/open-persona/SKILL.md` is a meta-skill for *using* the framework; this file guides *developing* it.

## Setup

```bash
npm install        # Install dependencies
node --test tests/ # Run all tests — must pass before any PR
```

- **Node.js ≥ 18** required (see `engines` in package.json)
- No build step — plain CommonJS, no transpilation
- Dependencies: fs-extra, mustache, commander, inquirer, chalk, adm-zip

## Project Structure

```
bin/cli.js              ← CLI entry point (commander-based)
lib/
  generator.js          ← Core persona generation logic (the heart of the project)
  installer.js          ← Persona installation to OpenClaw
  publisher/clawhub.js  ← Publishing to ClawHub registry
  contributor.js        ← Persona Harvest (community contribution)
  downloader.js         ← Preset/package downloading
  utils.js              ← Shared utilities
templates/
  skill.template.md          ← Mustache template → generated SKILL.md (four-layer headings)
  soul-injection.template.md ← Soul layer injection template
layers/
  soul/
    constitution.md     ← ⚠️ PROTECTED — universal ethical foundation
    README.md
    soul-state.template.json ← Evolution state template
  faculties/            ← Faculty implementations (voice, selfie, music, reminder)
  skills/               ← Local skill definitions (skill.json + SKILL.md per skill)
  embodiments/          ← Body layer definitions
schemas/                ← JSON schemas for validation
presets/                ← Pre-built persona definitions (samantha, ai-girlfriend, etc.)
tests/                  ← Node.js native test runner (node:test)
skills/open-persona/    ← Meta-skill for AI agents using the framework
```

## Architecture Rules

### Four-Layer Model

Every persona is a four-layer bundle:
1. **Soul** — personality, identity, ethical boundaries (`persona.json` + `constitution.md`). Key fields: `role` (free string, common values: companion/assistant/character/brand/pet/mentor/therapist/coach/collaborator/guardian/entertainer/narrator; custom values welcome), `sourceIdentity` (if present → digital twin of a real-world entity)
2. **Body** — physical embodiment (`embodiment.json`, null for digital agents)
3. **Faculty** — capabilities (voice, selfie, music, reminder)
4. **Skill** — actions the agent can take: local definitions in `layers/skills/`, or external via `install` field (ClawHub / skills.sh)

**Three orthogonal classification axes:**
- **Relationship role** (`role` field) — what the persona is to the user
- **Identity origin** (`sourceIdentity` field) — whether the persona mirrors a real-world entity
- **Physical form** (`layers.body`) — whether the persona has a physical embodiment

Note: `personaType` is deprecated — use `role` instead.

### Constitution (CRITICAL)

`layers/soul/constitution.md` is the universal ethical foundation inherited by ALL personas.

- **NEVER weaken or remove constitutional constraints**
- Personas can add stricter rules on top, but cannot loosen the constitution
- Section references use `§` prefix: `§1`, `§2`, etc. — never use `S1`, `S2`
- Priority ordering: **Safety > Honesty > Helpfulness**
- The generator (`lib/generator.js`) includes a compliance check that rejects `persona.json` boundaries attempting to loosen constitutional constraints

### Self-Awareness System

The generator equips every persona with layered self-awareness:

1. **Soul Foundation** (unconditional, in `soul-injection.template.md`) — Every persona knows: it is generated by OpenPersona, bound by the constitution (Safety > Honesty > Helpfulness), and that its host environment may impose additional constraints.

2. **Gap Awareness** (conditional, triggered by `hasSelfAwareness` flag) — When skills, faculties, or body declare an `install` field for a dependency not available locally, the generator classifies them as "soft references" and injects:
   - **`soul/injection.md`**: "Self-Awareness" section with dormant skills/faculties/embodiment/heartbeat and graceful degradation guidance
   - **`SKILL.md`**: "Expected Capabilities" section with install sources for operators

### Generated Skill Pack Structure

The generator outputs persona skill packs with this layout:
- **`SKILL.md`** — agent-facing index with four layer headings: `## Soul`, `## Body`, `## Faculty`, `## Skill`
- **`soul/`** — Soul layer artifacts: `persona.json`, `injection.md`, `identity.md`, `constitution.md`, `state.json`
- **`references/`** — on-demand detail docs: `<faculty>.md` per active faculty
- **`manifest.json`** — four-layer manifest (`layers.soul` → `./soul/persona.json`)
- **`scripts/`**, **`assets/`** — implementation scripts and static assets

### Local Persona Registry

`persona-registry.json` at `~/.openclaw/` tracks all installed personas. Maintained automatically by `install`, `uninstall`, and `switch` commands — no manual editing needed.

- Functions: `loadRegistry()`, `saveRegistry()`, `registryAdd()`, `registryRemove()`, `registrySetActive()` in `lib/utils.js`
- All accept optional `regPath` parameter for testing (defaults to `REGISTRY_PATH`)
- `listPersonas()` in `lib/switcher.js` uses registry as primary source, falls back to scanning `openclaw.json`

Key implementation details:
- Soft-ref detection: `lib/generator.js` checks each skill/faculty/body for `install` field + missing local definition
- All self-awareness flags (`hasSoftRefSkills`, `softRefSkillNames`, `hasSoftRefFaculties`, `softRefFacultyNames`, `hasSoftRefBody`, `softRefBodyName`, `softRefBodyInstall`, `heartbeatExpected`, `heartbeatStrategy`, `hasSelfAwareness`) are derived fields — they MUST be in the `DERIVED_FIELDS` array to prevent leaking into `persona.json` output
- `hasExpectedCapabilities` (in `skill.template.md`) deliberately excludes heartbeat — heartbeat is behavioral awareness, not an installable capability

### Template System

- Templates use **Mustache** syntax (`{{variable}}`, `{{#section}}...{{/section}}`)
- `skill.template.md` generates the persona's main SKILL.md
- `soul-injection.template.md` injects soul-layer instructions (including soul evolution and self-awareness)
- Template variables are populated by `lib/generator.js`

### Version Synchronization

All version references must stay in sync at `0.7.0`:
- `package.json` → `version`
- `bin/cli.js` → `.version()`
- `lib/generator.js` → `frameworkVersion` default
- `presets/*/manifest.json` → `meta.frameworkVersion`
- `skills/open-persona/SKILL.md` → frontmatter `version`

When bumping versions, update ALL of these locations.

## Code Style

- **CommonJS** (`require` / `module.exports`) — no ES modules
- **No transpilation** — code runs directly on Node.js ≥ 18
- **Quotes:** single quotes for strings
- **Error handling:** use `printError()` from `lib/utils.js` for user-facing errors
- **Path resolution:** use `resolvePath()` from `lib/utils.js`, never hardcode absolute paths
- **Dependencies:** prefer lightweight packages; the framework should stay lean

## Testing

```bash
npm test                    # Run all tests
node --test tests/generator.test.js  # Run specific test file
```

- Uses **Node.js native test runner** (`node:test` + `node:assert`)
- Tests create temp directories in `os.tmpdir()` and clean up after themselves
- Key test coverage: persona generation, constitution injection, compliance checks, faculty handling, skill resolution, external install, soul evolution, heartbeat sync, self-awareness (soft-ref skills/faculties/body/heartbeat, Soul Foundation, derived field exclusion)
- **All tests must pass before committing**

## Adding a New Faculty

1. Create directory: `layers/faculties/<name>/`
2. Add required files:
   - `faculty.json` — standard interface (name, dimension, description, allowedTools, envVars, triggers, files)
   - `SKILL.md` — behavior definition for the AI agent
   - `scripts/` — implementation scripts (optional)
3. Dimension must be one of: `expression`, `sense`, `cognition`
4. The generator auto-discovers faculties from `layers/faculties/` — no registration needed
5. Add tests if the faculty affects generation logic

## Adding a New Preset

1. Create directory: `presets/<slug>/`
2. Add `persona.json` (required fields: personaName, slug, bio, personality, speakingStyle)
3. Add `manifest.json` (must declare all four layers, set `meta.frameworkVersion`)
4. Test: `npx openpersona create --preset <slug> --output /tmp/test`
5. Update the preset table in `README.md` and `skills/open-persona/SKILL.md`

## Commit & PR Guidelines

- Run `npm test` before every commit
- Commit messages: concise, imperative mood (e.g., "Add reminder faculty", "Fix constitution compliance check")
- If changing the constitution, explain the ethical reasoning in the PR description
- If changing the generator, verify all presets still generate correctly
- If changing templates, check that generated SKILL.md output is valid markdown
